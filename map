#include "./function.h"
#include <stdio.h>
#include <string.h>

int main(int argc, char *argv[]) {
  if (argc != 2) {
    fprintf(stderr, "Usign: %s <filename>\n", argv[0]);
    return 0;
  }

  FILE *file;
  file = fopen(argv[1], "r");
  if (file == NULL) {
    fprintf(stderr, "%s opening failed.\n", argv[1]);
  }

  char buffer[1024];
  char args[1024];
  char *function;
  int number_line = 1;

  while (fgets(buffer, sizeof(buffer), file)) {

    buffer[strcspn(buffer, "\n")] = '\0';
    strcpy(args, buffer);
    function = strtok(buffer, " ");

    if (function == NULL) {
      number_line++;
      continue;
    }
    if (strcmp(function, "#") == 0) {
      number_line++;
      continue;
    }

    /*
    printf("DEBUG: buffer='%s'\n", buffer);
    printf("DEBUG: args='%s'\n", args);
    printf("DEBUG: function='%s'\n", function);
    */

    execute_command(function, args, number_line);

    number_line++;
  }
  return 0;
}
#ifndef FUNCTION_H
#define FUNCTION_H

void execute_command(char* function, char* args, int number_line);

#endif
#include "./function.h"
#include "./memory.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void print_function(char *args, int number_line) {
  char *arg;
  strtok(args, " ");

  while ((arg = strtok(NULL, " ")) != NULL) {
    if (arg[0] == '$') {
      int type = exist_vaiable(arg + 1);
      if (type == -1) {
        printf("ERROR: %s is not a variable",arg + 1);
        exit(1);
      } else if (type == 0) {
        printf("%s ", load_int(arg + 1));
      }else if (type == 1) {
        printf("%s ", load_str(arg + 1));
      }
    } else {
      printf("%s ", arg);
    }
  }
  printf("\n");
}

void shell_function(char *args, int number_line) {
  char *space = strchr(args, ' ');
  if (space != NULL) {
    system(space + 1);
  } else {
    printf("Error: No command at line %d\n", number_line);
  }
}

void int_function(char *args, int number_line) {
  char *name;
  int value;
  strtok(args, " ");
  name = strtok(NULL, " ");
  value = atoi(strtok(NULL, " "));
  add_int(value, name);
  // print_memory();
}

void str_function(char *args, int number_line) {
  char *name;
  char *value;

  strtok(args, " ");
  name = strtok(NULL, " ");
  value = strtok(NULL, "");

  if (name == NULL || value == NULL) {
    printf("Error: Invalid syntax at line %d\n", number_line);
    return;
  }

  add_str(value, name);
  // print_memory();
}

void execute_command(char *function, char *args, int number_line) {
  if (strcmp(function, "PRINT") == 0) {
    print_function(args, number_line);
  } else if (strcmp(function, "SHELL") == 0) {
    shell_function(args, number_line);
  } else if (strcmp(function, "INT") == 0) {
    int_function(args, number_line);
  } else if (strcmp(function, "STR") == 0) {
    str_function(args, number_line);
  } else {
    printf("\"%s\" is no a function | line <%d>\n", function, number_line);
    exit(1);
  }
}
#ifndef MEMORY_H
#define MEMORY_H

struct node {
  char *name;

  enum { INT_TYPE, STR_TYPE } type;
  
  union {
    int int_value;
    char str_value[100];
  } data;

  struct node *next;
};

typedef struct node node_t;

extern node_t *head;
extern node_t *tail;

void add_int(int value,char *name);
void add_str(char *value,char *name);

int exist_vaiable(char *name);
int load_int(char *name);
char* load_str(char *name);

// just for test
void print_memory();

#endif
#include "./memory.h"
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

node_t *head = NULL;
node_t *tail = NULL;

int exist_variable(char *name) {
  node_t *temp = head;
  int type = -1; // int = 0, str = 1, not_exist = -1
  while(temp != NULL) {
    if (strcmp(temp->name, name) == 0) {
      if (temp->type == INT_TYPE) {
        return 0;
      } 
      else if (temp->type == STR_TYPE) {
        return 1;
      }
    }
    temp = temp->next;
  }
  return -1;
}

int load_int(char *name) {
  node_t *temp = head;
  int value;
  while(temp != NULL) {
    if (strcmp(temp->name, name) == 0) {
      value = temp->data.int_value;
    }
    temp = temp->next;
  }
  return value;
}

char* load_str(char *name) {
  node_t *temp = head;
  char *value;
  while(temp != NULL) {
    if (strcmp(temp->name, name) == 0) {
      value = temp->data.str_value;
    }
    temp = temp->next;
  }
  return value;
}


void add_int(int value, char *name) {
  if (exist_variable(name) == -1) {
    printf("variable %s befor is exist\n",name);
    exit(1);
  }
  if (head == NULL) {
    node_t *temp = (node_t*)malloc(sizeof(node_t));
    head = temp;           
    tail = temp;            
    temp->type = INT_TYPE;  
    temp->data.int_value = value;
    temp->next = NULL;
    temp->name = strdup(name);
  } else {
    node_t *temp = (node_t*)malloc(sizeof(node_t));  
    tail->next = temp;     
    tail = temp;            
    temp->type = INT_TYPE;  
    temp->data.int_value = value;
    temp->next = NULL;
    temp->name = strdup(name);
  }
}

void add_str(char *value, char *name) {
  if (exist_variable(name) == -1) {
    printf("variable %s befor is exist\n",name);
    exit(1);
  }
  if (head == NULL) {
    node_t *temp = (node_t*)malloc(sizeof(node_t));
    head = temp;          
    tail = temp;            
    temp->type = STR_TYPE;  
    strcpy(temp->data.str_value, value); 
    temp->next = NULL;
    temp->name = strdup(name);
  } else {
    node_t *temp = (node_t*)malloc(sizeof(node_t));  
    tail->next = temp;      
    tail = temp;           
    temp->type = STR_TYPE;
    strcpy(temp->data.str_value, value);
    temp->next = NULL;
    temp->name = strdup(name);
  }
}

// just for test
void print_tail() {
  printf("tail_name: %s\n", tail->name);
}

void print_head() {
  printf("head->name: %s\n", head->name);
}

void print_memory() {
  node_t *temp = head;
  while (temp != NULL) {
    if (temp->type == INT_TYPE) {
      printf("name: %s | value: %d | type: INT_TYPE\n", temp->name, temp->data.int_value);
    } else if (temp->type == STR_TYPE) {
      printf("name: %s | value: %s | type: STR_TYPE\n", temp->name, temp->data.str_value);
    }
    temp = temp->next;
  }
  print_head();
  print_tail();
}
